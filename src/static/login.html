<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- third party libraries -->
  <script src="jquery-1.12.0.min.js"></script>
  <script src="jquery.jsonrpcclient.js"></script>
  <script src="jquery.color-2.1.2.min.js"></script>
  <script src="jquery-ui-1.11.4/jquery-ui.js"></script>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="bootstrap-theme.min.css">
  <script src="bootstrap.min.js"></script>

  <link rel="stylesheet" href="inv.css">

  <script>
    function getPlayerId(type) {
      if (type === "existing") {
        return $("#uname").val(function(index, value) {
          return value;
        })[0].value;
      }
      else {
        return $("#unameNew").val(function(index, value) {
          return value;
        })[0].value;
      }
    }

    function getPlayerPwd(type) {
      if (type === "existing") {
        return $("#pwd").val(function(index, value) {
          return value;
        })[0].value;
      }
      else {
        return $("#pwdNew").val(function(index, value) {
          return value;
        })[0].value;
      }
    }

    function getPlayerPwdConf() {
      return $("#pwdNewConf").val(function(index, value) {
        return value;
      })[0].value;
    }

    function validateLogin(id, pwd, cb) {
      if (id.length === 0 || pwd.length === 0) {
        cb(false);
      }

      r = rpc.call("App.checkLogin", [id, pwd], function(result) {
        if (result === "valid") {
          cb(true);
        }
        else if (result === "invalid") {
          cb(false);
        }
      });

    }

    function validateNewLogin(id, pwd, pwdConf) {
      if (id.length === 0 || pwd.length === 0 || pwdConf.length === 0) {
        $("#invalidNew").hide();
        $("#invalidMatch").hide();
        $("#invalidEmpty").show();
        return false;
      }

      if (pwd === pwdConf) {
        return true;
      }
      else {
        $("#invalidNew").hide();
        $("#invalidMatch").show();
        $("#invalidEmpty").hide();
        return false;
      }
    }

    function createPlayer(id, pwd) {
      r = rpc.call("App.newPlayer", [id, pwd], function(result) {
            if (result) {
              return false;
            }
            else {
              return true;
            }
          });
    }

    function login() {
      id = getPlayerId("existing")
      pwd = getPlayerPwd("existing")

      validateLogin(id, pwd, function(result) {
        if (result) {
          $("#invalid").hide();
          $("#invalidNew").hide();
          $("#invalidMatch").hide();
          $("#invalidEmpty").hide();
          sessionStorage.setItem("playerId", id);
          redirect();
        }
        else {
          $("#invalid").show();
        }
      });

    }

    function createNewPlayer() {
      id = getPlayerId("new")
      pwd = getPlayerPwd("new")
      pwdConf = getPlayerPwdConf()

      if (validateNewLogin(id, pwd, pwdConf)) {
        $("#invalid").hide();
        $("#invalidNew").hide();
        $("#invalidMatch").hide();
        $("#invalidEmpty").hide();
        createPlayer(id, pwd);
        sessionStorage.setItem("playerId", id);
        redirect();
      }
      else {
        // move this inside validateNewLogin
        $("#invalid").hide();
        $("#invalidNew").show();
      }
    }

    function redirect() {
      window.location.href = "menu.html";
    }

    function resetExisting() {
      $("#uname").val("");
      $("#pwd").val("");
      $("#invalid").hide();
    }

    function resetNew() {
      $("#unameNew").val("");
      $("#pwdNew").val("");
      $("#pwdNewConf").val("");
      $("#invalidNew").hide();
      $("#invalidMatch").hide();
      $("#invalidEmpty").hide();
    }

    function clearFields() {
      resetExisting();
      resetNew();
    }

    $(document).ready(function() {
      rpc = new $.JsonRpcClient({ ajaxUrl: "/api" });

      clearFields();

      $("#invalid").hide();
      $("#invalidNew").hide();
      $("#invalidMatch").hide();
      $("#invalidEmpty").hide();

      $("#login").click(login);
      $("#reset").click(resetExisting);

      $("#create").click(createNewPlayer);
      $("#resetNew").click(resetNew);

      sessionStorage.clear();
    });
  </script>
</head>

<body>
  <div class="container">
    <div class="row menu">
      <h2>Multiplayer inv-gen-game</h2>
    </div>

    <div class="row menu">
      <div class="col-md-2" id="left">
      </div>
      <div class="col-md-4 col-sm-12">
        <h3>Existing Player</h3>
        <div class="container">
          <div class="row">
            <div class="col-md-1">
              <label><b>Username</b></label>
            </div>
            <div class="col-md-2">
              <input type="text" placeholder="Enter Username" id="uname" required>
            </div>
          </div>
          <br />
          <div class="row">
            <div class="col-md-1">
              <label><b>Password</b></label>
            </div>
            <div class="col-md-2">
              <input type="password" placeholder="Enter Password" id="pwd" required>
            </div>
          </div>
          <br />
          <div class="row">
            <button type="submit" id="login" class="btn btn-quit">Login</button>
            <button type="submit" id="reset" class="btn btn-quit">Reset</button>
          </div>
          <label id="invalid" class="error">Invalid username or password</label>
        </div>
      </div>

      <div class="col-md-4 col-sm-12">
        <h3>New Player</h3>
          <div class="container">
            <div class="row">
              <div class="col-md-1">
                <label><b>Username</b></label>
              </div>
              <div class="col-md-2">
                <input type="text" placeholder="Enter Username" id="unameNew" required>
              </div>
            </div>
            <br />
            <div class="row">
              <div class="col-md-1">
                <label><b>Password</b></label>
              </div>
              <div class="col-md-2">
                <input type="password" placeholder="Enter Password" id="pwdNew" required>
              </div>
            </div>
            <br />
            <div class="row">
              <div class="col-md-1">
                <label><b>Confirm</b></label>
              </div>
              <div class="col-md-2">
                <input type="password" placeholder="Enter Password Again" id="pwdNewConf" required>
              </div>
            </div>
            <br />
            <div class="row">
              <button type="submit" id="create" class="btn btn-quit">Create</button>
              <button type="submit" id="resetNew" class="btn btn-quit">Reset</button>
            </div>
            <label id="invalidNew" class="error">The username already exists</label>
            <label id="invalidMatch" class="error">The passwords do not match</label>
            <label id="invalidEmpty" class="error">The fields cannot be empty</label>
          </div>
      </div>

      <div class="col-md-2" id="right">
      </div>
    </div>
  </div>
</body>
</html>
