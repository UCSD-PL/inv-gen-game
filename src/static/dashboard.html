<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Dashboard</title>

  <!-- Third party libraries -->
  <script src="jquery-1.12.0.min.js"></script>
  <script src="jquery.jsonrpcclient.js"></script>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="bootstrap-theme.min.css">
  <script src="bootstrap.min.js"></script>

  <!-- Our code -->
  <link rel="stylesheet" href="inv.css">
  <link rel="stylesheet" href="admin.css">
  <script src="build/ts/util.js"></script>

  <script type="text/javascript">
    var adminToken;
    var refreshIntervalId;
    var refreshClock = 0;
    var rowUpdater;

    function stopRefresh() {
      clearInterval(refreshIntervalId);
      $("#refresh_clock").text("never");
      $("#stop_refresh").hide();
    }

    function updater(head) {
      var cache = new Map();

      var obj = {
        inject: function(at, key, data, create, update) {
          var skey = JSON.stringify(key);
          var item;
          if (cache.has(skey)) {
            item = cache.get(skey);
          } else {
            item = create(data);
            cache.set(skey, item);
          }
          update(item, data);
          at.after(item.detach());
          return item;
        },

        update: function(ondata) {
          var ptr = head;
          var keepkeys = new Set();

          ondata(function(key, data, create, update) {
            var skey = JSON.stringify(key);
            var item = obj.inject(ptr, key, data, create, update);
            keepkeys.add(skey);
            ptr = item;
            return item;
          });

          for (let skey of cache.keys()) {
            if (!keepkeys.has(skey)) {
              cache.get(skey).detach();
              cache.delete(skey);
            }
          }
        }
      };

      return obj;
    }

    function createSummaryRow(data) {
      return $("<tr>")
        .addClass("summary-row")
        .append($("<td>")
          .text(data.experiment)
        )
        .append($("<td>")
          .text(data.lvl)
        )
        .append($("<td>")
          .addClass("col-nStarted")
        )
        .append($("<td>")
          .addClass("col-nFinished")
        )
        .append($("<td>")
          .addClass("col-nProved")
        );
    }

    function updateSummaryRow(row, data) {
      if (JSON.stringify(row.data("rowdata")) === JSON.stringify(data))
        return;

      for (let field of ["nStarted", "nFinished", "nProved"]) {
        row.find(".col-" + field)
          .text(data[field]);
      }

      row.data("rowdata", data);
    }

    function createDetailRow(data) {
      return $("<tr>")
        .addClass("detail-row")
        .append($("<td>")
          .attr("colspan", 5)
        );
    }

    function updateDetailRow(rpc, row, data) {
      rpc.call("App.getDashboardInvs", [adminToken, data.experiment,
        data.lvl], function(res) {
        console.log(new Date(), "App.getDashboardInvs", res);

        if (JSON.stringify(row.data("rowdata")) === JSON.stringify(res))
          return;

        hlist = $("<dl>");
        $.each(res, function(hit, invs) {
          invlist = $("<ul>")
            .addClass("list-inline");
          for (let inv of invs) {
            invlist.append($("<li>")
              .text(inv)
            );
          }

          hlist.append($("<dt>")
              .text("HIT: " + hit)
            )
            .append($("<dd>")
              .append(invlist)
            );
        });

        row.find("td")
          .empty()
          .append(hlist);

        row.data("rowdata", res);
      });
    }

    function expandSummary(rpc, item, rowdata, updater) {
      var dkey = ["detail", rowdata.experiment, rowdata.lvl];
      updater(dkey, rowdata, createDetailRow,
        (row, data) => updateDetailRow(rpc, row, data));
    }

    function loadDashboard(rpc) {
      rpc.call("App.getDashboard", [adminToken], function(res) {
        console.log(new Date(), "App.getDashboard", res);

        rowUpdater.update(function(updatekey) {
          for (let rowdata of res) {
            var key = [rowdata.experiment, rowdata.lvl];
            var item = updatekey(key, rowdata, createSummaryRow,
              updateSummaryRow);
            if (item.data("expand")) {
              expandSummary(rpc, item, rowdata, updatekey);
            }
          }
        });
      }, function(err) {
        stopRefresh();
        alert("RPC Error: " + err.message);
      });
    }

    $(document).ready(function() {
      rpc = new $.JsonRpcClient({ ajaxUrl: "/api" })
      adminToken = Args.get_admin_token();
      rowUpdater = updater($("#summary_tbody .head"));

      refreshIntervalId = setInterval(function() {
        if (refreshClock <= 0) {
          refreshClock = 5;
          loadDashboard(rpc);
        } else {
          refreshClock -= 1;
        }
        $("#refresh_clock").text(refreshClock);
      }, 1000);

      $("#stop_refresh").click(stopRefresh);

      $("#summary_tbody").click(function(event) {
        event.stopPropagation();

        var item = $(event.target).closest("tr");
        if (item.hasClass("summary-row")) {
          nitem = item.next();
          if (nitem.hasClass("detail-row")) {
            item.data("expand", false);
            nitem.detach();
          } else {
            item.data("expand", true);
            expandSummary(rpc, item, item.data("rowdata"),
              (k, d, c, u) => rowUpdater.inject(item, k, d, c, u));
          }
        }
      });
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>Dashboard</h1>
    <p class="text-muted">
      Auto-refresh in: <span id="refresh_clock"></span>
      <a href="#" id="stop_refresh">stop</a>
    </p>
    <div class="panel panel-default">
      <div class="panel-body">
        <table class="table">
          <thead>
            <tr>
              <th>Experiment</th>
              <th>Level Name</th>
              <th># Started</th>
              <th># Finished</th>
              <th># Proved</th>
            </tr>
          </thead>
          <tbody id="summary_tbody">
            <tr class="head"></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
