<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Dashboard</title>

  <!-- Third party libraries -->
  <script src="jquery-1.12.0.min.js"></script>
  <script src="jquery.jsonrpcclient.js"></script>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="bootstrap-theme.min.css">
  <script src="bootstrap.min.js"></script>

  <!-- Our code -->
  <link rel="stylesheet" href="inv.css">
  <link rel="stylesheet" href="admin.css">
  <script src="build/ts/util.js"></script>

  <script type="text/javascript">
    var adminToken;
    var refreshIntervalId;
    var refreshClock = 0;

    function stopRefresh() {
      clearInterval(refreshIntervalId);
      $("#refresh_clock").text("never");
      $("#stop_refresh").hide();
    }

    function loadDashboard(rpc) {
      rpc.call("App.getDashboard", [adminToken], function (res) {
        console.log(new Date(), "App.getDashboard", res);

        expandrows = new Set();
        $("#summary_tbody .detail-row").each(function (i, trow) {
          rowkey = $(trow).data("row-key");
          expandrows.add(rowkey);
        });

        var tbody = $("<tbody>");
        for (row of res) {
          rowkey = JSON.stringify([row.experiment, row.lvl]);

          trow = $("<tr>")
            .addClass("data-row")
            .append($("<td>")
              .text(row.experiment)
            )
            .append($("<td>")
              .text(row.lvl)
            )
            .append($("<td>")
              .text(row.nStarted)
            )
            .append($("<td>")
              .text(row.nFinished)
            )
            .append($("<td>")
              .text(row.nProved)
            )
            .data("row-key", rowkey);
          tbody.append(trow);

          if (expandrows.has(rowkey)) {
            populateRowDetail(trow);
          }
        }

        // This will flicker on update. We should move/change existing
        // elements where possible instead of replacing the entire table.
        $("#summary_tbody").empty().append(tbody.children().detach());
      }, function (err) {
        stopRefresh();
        alert("RPC Error: " + err.message);
      });
    }

    function populateRowDetail(trow) {
      rowkey = trow.data("row-key");

      rk = JSON.parse(rowkey);
      experiment = rk[0];
      lvl = rk[1];

      rpc.call("App.getDashboardInvs", [adminToken, experiment, lvl],
        function (res) {
        console.log(new Date(), "App.getDashboardInvs", res);

        hlist = $("<dl>");
        $.each(res, function (hit, invs) {
          invlist = $("<ul>")
            .addClass("list-inline");
          for (inv of invs) {
            invlist.append($("<li>")
              .text(inv)
            );
          }

          hlist.append($("<dt>")
            .text("HIT: " + hit)
          )
          .append($("<dd>")
            .append(invlist)
          );
        });

        trow.after($("<tr>")
          .addClass("detail-row")
          .append($("<td>")
            .attr("colspan", 5)
              .append(hlist)
            )
          .data("row-key", trow.data("row-key"))
        );
      });
    }

    $(document).ready(function () {
      rpc = new $.JsonRpcClient({ ajaxUrl: "/api" })
      adminToken = Args.get_admin_token();

      refreshIntervalId = setInterval(function () {
        if (refreshClock <= 0) {
          refreshClock = 5;
          loadDashboard(rpc);
        } else {
          refreshClock -= 1;
        }
        $("#refresh_clock").text(refreshClock);
      }, 1000);

      $("#stop_refresh").click(stopRefresh);

      $("#summary_tbody").click(function (event) {
        event.stopPropagation();

        var trow = $(event.target).closest("tr");
        if (trow.hasClass("data-row")) {
          nrow = trow.next();
          if (nrow.hasClass("detail-row")) {
            nrow.remove();
          } else {
            populateRowDetail(trow);
          }
        }
      });
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>Dashboard</h1>
    <p class="text-muted">
      Auto-refresh in: <span id="refresh_clock"></span>
      <a href="#" id="stop_refresh">stop</a>
    </p>
    <div class="panel panel-default">
      <div class="panel-body">
        <table class="table">
          <thead>
            <tr>
              <th>Experiment</th>
              <th>Level Name</th>
              <th># Started</th>
              <th># Finished</th>
              <th># Proved</th>
            </tr>
          </thead>
          <tbody id="summary_tbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
