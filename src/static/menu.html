<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- third party libraries -->
  <script src="jquery-1.12.0.min.js"></script>
  <script src="jquery.jsonrpcclient.js"></script>
  <script src="jquery.color-2.1.2.min.js"></script>
  <script src="jquery-ui-1.11.4/jquery-ui.js"></script>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="bootstrap-theme.min.css">
  <script src="bootstrap.min.js"></script>
  <link rel="stylesheet" href="jquery-ui-1.11.4/jquery-ui.css">

  <link rel="stylesheet" href="inv.css">

  <script>
    var idLength = 8;
    var playerGen = 0;
    var players = [];
    var rank = null;

    function isPlayerIdPresent(playerId, cb) {
      res = rpc.call("App.get", ["players"], function(resp) {
        if(resp) {
          playerGen = resp[0];
          players = JSON.parse(resp[1]);
          if(players === undefined || players.indexOf(playerId) === -1) {
            players = [];
            cb(false);
          }
          else {
            cb(true);
          }
        }
      });
    }
    
    function isGameIdPresent(gameId) {
      return rpc.call("App.get", [gameId], function(res) {
        if(res) {
          return true;
        }
        else {
          return false;
        }
      });
    }

    function startGame() {
      var gameId = Math.round((Math.pow(36, idLength + 1) - Math.random() * Math.pow(36, idLength))).toString(36).slice(1);
      res = isGameIdPresent(gameId);
      res.then(function (result) {
        if(result.error) {
          init = rpc.call("App.set", [gameId, "{}", -1], function(result) {
            if (result) {
              var id = getPlayerId();
              rpc.call("App.newScore", [id, gameId], function() {
                sessionStorage.setItem("score", 0);
                sessionStorage.setItem("gameId", gameId);
                window.location.href = "game_np.html?gameId=" + gameId;
              });
            }
            else {
              console.log("Error starting game " + gameId);
              console.log(result);
            }
          })
        }
        else {
          startGame();
        }
      });
    }

    function getPlayerId() {
      return sessionStorage.getItem("playerId");
    }
    
    function getGameId() {
      return $("#gameId").val(function(index, value) {
        return value;
      })[0].value;
    }
    
    function validateGameId() {
      var filled = false;
      var id = getGameId();
      
      if(id === "") {
        filled = false;
      }
      else if(id) {
        filled = true;
      }

      $("#notFound").hide();
      $("#join").prop("disabled", !filled);
    }
    
    function checkGameId() {
      var gameId = getGameId();

      res = isGameIdPresent(gameId);

      res.then(function (result) {
        if(result.error) {
          $("#notFound").show();
          $("#notFound").text("Sorry, no game found with ID " + gameId + ".");
        }
        else {
          window.location.href = "game_np.html?gameId=" + gameId;
        }
      });
    }

    function showJoin() {
      getGames();
      $("#options").hide();
      $("#joinGame").show();
    }

    function hideJoin() {
      $("#options").show();
      $("#joinGame").hide();
    }

    function logout() {
      window.location.href = "login.html";
    }

    function setHeader() {
      var pid = sessionStorage.getItem("playerId");
      var res = rpc.call("App.getTotalScore", [pid], function(res) {
        $("#pid").html("Player: " + pid);
        $("#points").html("Points: " + res);
        $("#rank").html("Rank: " + rank);
      });
    }

    function getLeaderboard() {
      var res = rpc.call("App.getAllScores", [], function(result) {
        if (result) {
          var table = "<h4>Leaderboard</h4><table class='tg'><tr><th class='tg-9hbo'>Rank</th><th class='tg-9hbo'>Player</th><th class='tg-9hbo'>Points</th></tr>"
          var rows = (result.length < 10) ? result.length : 10;
          for (var i = 0; i < rows; i++) {
            table += "<tr><td class='tg-yw4l'>" + (i+1) + "</td><td class='tg-yw4l'>" + result[i][0] + "</td><td class='tg-yw4l'>" + result[i][1] + "</td></tr>"
            var id = sessionStorage.getItem("playerId");
            if (id === result[i][0]) {
              rank = i+1;
            }
          }
          table += "</table>"
          $("#leaderboard").html(table);
        }
      });
    }

    function getGames() {
      var res = rpc.call('App.getGames', [], function(res) {
        allGames = []
        for (var id in res) {
          var currentGameId = id;
          var result = res[id][1];
          var currentGamePlayers = result ? result.players.length : 0;
          var currentGameExpressions = result ? result.expressions : {};

          var expr = [];
          for (var lvl in currentGameExpressions) {
            for (var inv in currentGameExpressions[lvl]) {
              expr.push(inv);
            }
          }
          currentGameExpressions = expr;
          
          allGames.push({
            id: currentGameId,
            players: currentGamePlayers,
            expr: currentGameExpressions.length,
          });
        }

        var table = "<table class='tg'><tr><th class='tg-9hbo'>Game</th><th class='tg-9hbo'># Players</th><th class='tg-9hbo'># Expressions</th></tr>"
        for (var i = 0, len = allGames.length; i < len; i++) {
          table += "<tr><td class='tg-yw4l'><a href='" + (window.location.origin + "/game_np.html?gameId=" + allGames[i].id) + "'>" + allGames[i].id + "</a></td><td class='tg-yw4l'>" + allGames[i].players + "</td><td class='tg-yw4l'>" + allGames[i].expr + "</td></tr>"
        }
        table += "</table>";
        $("#gameList").html(table);
        setHeader();
      });
    }

    $(document).ready(function() {
      var playerId = sessionStorage.getItem("playerId");

      if(playerId === null) {
        logout();
      }

      rpc = new $.JsonRpcClient({ ajaxUrl: "/api" });
      
      getLeaderboard();
      getGames();
      
      $("#joinGame").hide();
      $("#gameId").val("");
      $("#notFound").hide();

      $("#optStart").click(startGame);
      $("#optJoin").click(showJoin);
      $("#optLogout").click(logout);
      $("#optBackJoin").click(hideJoin);
      $("#gameId").keyup(validateGameId);
      $("#join").click(checkGameId);
      $(".ui-tabs-tab").click(function() {$("#joinGame").hide()});
      $("#leaderboard").click(getLeaderboard);
      $("#profile").click(setHeader);
      $("#tabs").tabs();

      $('#tutorial').click(function() {
        window.open('tutorial_patterns.html?tutorialAction=redo-all', '_blank').focus();
      })

      $("#final-submit").click(function() {

      })
    })
  </script>
</head>

<body>
  <div class="container">
    <div class="row menu">
      <h2>Multiplayer inv-gen-game</h2>
    </div>

    <div id="tabs" class="ui-tabs">
      <ul role="tablist" class="ui-tabs-nav">
        <li role="tab" class="ui-tabs-tab" tabindex="0"><a href="#profile" class="ui-tabs-anchor" role="presentation">Profile</a></li>
        <li role="tab" class="ui-tabs-tab" tabindex="1"><a href="#tutorials" class="ui-tabs-anchor" role="presentation">How To Play</a></li>
        <li role="tab" class="ui-tabs-tab" tabindex="2"><a href="#options" class="ui-tabs-anchor" role="presentation">Play</a></li>
        <li role="tab" class="ui-tabs-tab" tabindex="3"><a href="#leaderboard" class="ui-tabs-anchor" role="presentation">Leaderboard</a></li>
        <li role="tab" class="ui-tabs-tab" tabindex="4"><a href="#feedback" class="ui-tabs-anchor" role="presentation">Feedback</a></li>
      </ul>
      
      <div id="profile" class="row menu">
        <h4 id="pid"></h4>
        <h4 id="points"></h4>
        <h4 id="rank"></h4>
        <br />
        <button id="optLogout" class="btn-quit">Logout</button>
      </div>

      <div id="tutorials" class="row menu">
        Click here to launch the tutorial: <button id="tutorial" class="btn-quit">Tutorial</button>
        <br /><br />
      </div>

      <div id="options" class="row menu">
        <button id="optStart" class="btn-quit">New Game</button>
        <br /><br />
        <button id="optJoin" class="btn-quit">Join Game</button>
        <br /><br />
      </div>

      <div class="row menu" id="joinGame" hidden="true">
        <label id="lblJoin">Enter Game ID:</label>
        <input id="gameId" type="text" placeholder="Enter Game ID"></input>
        <br />
        <button id="join" type="submit" class="btn-quit" disabled="true">Join</button>
        <button id="optBackJoin" type="button" class="btn-quit">Back</button>
        <br />
        <label id="notFound" class="error"></label>
        <br /><br />
        OR
        <br /><br />
        Select a game from below:
        <div id="gameList"></div>
      </div>

      <div id="leaderboard" class="row menu"></div>

      <div id="feedback" class="row menu">
        <div class="container">
          <h2 class='text-center'>Please answer a few questions and click on Finish below.(* means required)</h2>
          <form action="" id="turk-form">
            <label class="statement fun">This sesssion was fun to play.*</label>
            <ul class='likert'>
              <li>
                <input type="radio" name="fun" value="5">
                <label>Strongly agree</label>
              </li>
              <li>
                <input type="radio" name="fun" value="4">
                <label>Agree</label>
              </li>
              <li>
                <input type="radio" name="fun" value="3">
                <label>Neutral</label>
              </li>
              <li>
                <input type="radio" name="fun" value="2">
                <label>Disagree</label>
              </li>
              <li>
                <input type="radio" name="fun" value="1">
                <label>Strongly disagree</label>
              </li>
            </ul>
            <label class="statement challenging">This session was challenging.*</label>
            <ul class='likert'>
              <li>
                <input type="radio" name="challenging" value="5">
                <label>Strongly agree</label>
              </li>
              <li>
                <input type="radio" name="challenging" value="4">
                <label>Agree</label>
              </li>
              <li>
                <input type="radio" name="challenging" value="3">
                <label>Neutral</label>
              </li>
              <li>
                <input type="radio" name="challenging" value="2">
                <label>Disagree</label>
              </li>
              <li>
                <input type="radio" name="challenging" value="1">
                <label>Strongly disagree</label>
              </li>
            </ul>
            <label class="statement prog_experience">What is your level of expertise in programming?*</label>
            <ul class='likert'>
              <li>
                <input type="radio" name="prog_experience" value="1">
                <label>None</label>
              </li>
              <li>
                <input type="radio" name="prog_experience" value="2">
                <label>Novice</label>
              </li>
              <li>
                <input type="radio" name="prog_experience" value="3">
                <label>Intermediate</label>
              </li>
              <li>
                <input type="radio" name="prog_experience" value="4">
                <label>Advanced</label>
              </li>
              <li>
                <input type="radio" name="prog_experience" value="5">
                <label>Professional</label>
              </li>
            </ul>
            <label class="statement math_experience">What is the highest education level, at which you took a math course?*</label>
            <ul class='likert'>
              <li>
                <input type="radio" name="math_experience" value="1">
                <label>Middle-school or less (class &lt;9)</label>
              </li>
              <li>
                <input type="radio" name="math_experience" value="2">
                <label>High-school (class 9-12)</label>
              </li>
              <li>
                <input type="radio" name="math_experience" value="3">
                <label>Bachelors</label>
              </li>
              <li>
                <input type="radio" name="math_experience" value="4">
                <label>Masters</label>
              </li>
              <li>
                <input type="radio" name="math_experience" value="5">
                <label>PhD</label>
              </li>
            </ul>
            <fieldset class="form-group">
              <label for="likes_input">Any comments? Likes, Dislikes?</label>
              <textarea name="likes" class="form-control" rows="2" id="likes_input" style="width: 50%;"></textarea>
            </fieldset>
            <button id="final-submit" class="btn-next">Finish</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</body>
</html>